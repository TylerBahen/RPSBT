<!DOCTYPE html>
<html lang="en">
<head>
    <style>
        body {
            padding:0px;
            margin:0px;
        }
        #gameWindow {
            width:80%;
            height:80%;
            border: ridge gray 5px;
            background-color: white;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: grid;
            grid-template-columns: repeat(5,1fr);
            grid-template-rows: repeat(6,1fr);
            place-items: center;
            visibility: hidden;
        }
        progress {
            accent-color: red;
            width:100%;
            height:30px
        }

        #opponentHealth {
            grid-column: 2 / span 3;
            grid-row: 1;
        }
        #playerHealth {
            grid-row: 6;
            grid-column: 2 / span 3;
        }
        .card {
            text-align: center;
            align-content: center;
            width:95%;
            height:95%;
        }
        #opp1 {
            grid-column: 2;
            grid-row:2
        }
        #opp2 {
            grid-column: 3;
            grid-row:2
        }
        #opp3 {
            grid-column: 4;
            grid-row:2
        }
        #oppPlayed {
            grid-column: 3;
            grid-row:3;
            visibility: hidden;
        }
        #hnd1 {
            grid-column: 2;
            grid-row:5
        }
        #hnd2 {
            grid-column: 3;
            grid-row:5
        }
        #hnd3 {
            grid-column: 4;
            grid-row:5
        }
        #hndPlayed {
            grid-column: 3;
            grid-row: 4;
            visibility: hidden;
        }
        #notouch {
            width:80%;
            height:80%;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            opacity: 0;
            visibility: hidden;
        }
        #popup {
            pointer-events: none;
            user-select: none;
            position: fixed;
            top: 20%;
            left:50%;
            transform: translate(-50%, -20%);
            visibility: hidden;
            color: #300000;
            text-align: center;
            background:none;
            text-shadow: 1px 1px 3px #222;
        }
        nav {
            display: flex;
            flex-wrap: wrap;
            margin:0px;
            padding:0px;
            width:100%;
            height:50px;
            background-color: gray;
            border-bottom: 7px ridge lightgray;
        }
        nav button {
            height:50px;
            flex: 1 1 20%;
            min-width: 300px;
        }

        #shopWindow {
            width:80%;
            height:80%;
            border: solid black 3px;
            background-color: white;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: grid;
            grid-template-columns: repeat(3,1fr);
            grid-template-rows: 150px 30px 1fr 1fr;
            place-items: center;
            visibility: hidden;
        }
        #shopTitle {
            grid-column: 1 / span 3;
            text-align: center;
            align-content: bottom;
        }
        #goldDisplay {
            grid-column: 1 / span 3;
            text-align: center;
            align-content: top;
        }
        #commonPack {
            height: 100%;
            width:100%;
            align-items: center;
            text-align: center;
        }
        .close {
            cursor: pointer;
            position: absolute;
            top: 0%;
            right: 0%;
            display:block;
            color:red;
            border-style:outset;
        }

        .close:hover {
            background: #bbb;
            color:white;
            border-style:inset;
        }
        #deckWindow {
            width:80%;
            height:80%;
            border: solid black 3px;
            background-color: white;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: grid;
            grid-template-columns: repeat(3,1fr);
            grid-template-rows: auto 20px 2fr 1fr;
            place-items: center;
            visibility: hidden;
        }
        #deckTitle {
            grid-column: 1 / span 3;
            text-align: center;
        }
        .pileLabel {
            text-align: center;
        }
        #pile0 {
            border: solid black 3px;
            overflow:auto;
            width:80%;
            height:90%;
        }
        #pile1 {
            border: solid black 3px;
            overflow:auto;
            width:80%;
            height:90%;
        }
        #pile2 {
            border: solid black 3px;
            overflow:auto;
            width:80%;
            height:90%;
        }
        #cardPicker {
            grid-column: 1 / span 3;
            width: 80%;
            height:80%;
            text-align: center;
            align-content: center;
            border: solid black 3px;
            overflow: auto;
        }
        .cardBtn {
            width:100%;
            height:16.666%;
        }
        .shopBtn {
            width:200px;
            max-width:80%;
            height:95%;
        }
    </style>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPS: Beyond the Triad</title>
</head>
<body>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        var socket = io()

        const urlParams = new URLSearchParams(window.location.search);
        const entries = urlParams.entries();
        const quer = {};
        for (entry of entries) {
            quer[entry[0]] = entry[1];
        }
        if (quer.user==undefined){
            quer.user = ''
        }
        socket.emit('auth',quer['user'],(authenticated,playerData,cardLib) => {
            if(authenticated){
                console.log('Player Authenticated')
                //history.replaceState(null, '',window.location.pathname);
                var data = JSON.parse(playerData)
                console.log(data)
                deck = data.deck
                gold = data.gold
                bank = data.cards
                cardData = JSON.parse(cardLib)
            } else {
                window.location.replace('/')
            }
        })
        socket.on('reauth',() => {
            alert('Your window has expired and needs to be re-authenticated. You are being moved to the login screen...')
            window.location.replace('/login')
        })

        
        //Game Stuff
        var deck = [[],[],[]]
        var gold = 0
        var bank = []
        var cardData
        var hand = []

        function gameSearch(){
            socket.emit('searching',deck)
            disableBtns()
            popup('Searching for opponent...')
        }
        socket.on('gamestart',(player,opponent)=> {
            popup('Match started with '+JSON.parse(opponent).name)
            openboard()
            update(JSON.parse(player),JSON.parse(opponent))
        })
        socket.on('moved',(player,opponent) => {
            update(JSON.parse(player),JSON.parse(opponent))
        })
        var chosencard = undefined
        var pilenum = 0
        socket.on('playreq',(callback) => {
            callback(chosencard,pilenum)
            chosencard = undefined
        })
        socket.on('victory',(reason) => {
            switch (reason){
                case 'normal':
                    popup('You win!')
                    break
                case 'disconnect':
                    popup('Your opponent disconnected and forfeit!')
                    break
                case 'forfeit':
                    popup('Your opponent forfeit!')
                    break
            }
            setTimeout(closeboard,1100)
        })
        socket.on('defeat',(reason) => {
            switch (reason){
                case 'normal':
                    popup('You Lose.')
                    break
                case 'tie':
                    popup('It was a tie.')
                    break
            }
            setTimeout(closeboard,1100)
        })
        var oppId = 'oppPlayed'
        function update(player,opponent){
            chosencard = undefined
            deck = player.deck
            document.getElementById('playerHealth').value = String(player.hp)
            document.getElementById('opponentHealth').value = String(opponent.hp)
            if (player.vision == true){
                document.getElementById('opp1').innerHTML = opponent.deck[0][0]
                document.getElementById('opp2').innerHTML = opponent.deck[1][0]
                document.getElementById('opp3').innerHTML = opponent.deck[2][0]
            } else {
                document.getElementById('opp1').innerHTML = ''
                document.getElementById('opp2').innerHTML = ''
                document.getElementById('opp3').innerHTML = ''
            }
            document.getElementById('hnd1').innerHTML = player.deck[0][0]
            document.getElementById('hnd1').title = cardData[player.deck[0][0]].desc
            document.getElementById('hnd2').innerHTML = player.deck[1][0]
            document.getElementById('hnd2').title = cardData[player.deck[1][0]].desc
            document.getElementById('hnd3').innerHTML = player.deck[2][0]
            document.getElementById('hnd3').title = cardData[player.deck[2][0]].desc
            switch (opponent.cardnum){
                case 0:
                    oppId = 'opp1'
                    break
                case 1:
                    oppId = 'opp2'
                    break
                case 2:
                    oppId = 'opp3'
                    break
            }
            document.getElementById(oppId).style.visibility = 'hidden'
            document.getElementById('oppPlayed').innerHTML = opponent.card
            if (opponent.card==undefined){
                //do nothing
            } else {
                popup(player.message)
                document.getElementById('oppPlayed').style.visibility = 'visible'
            }
            setTimeout(clearboard,2000)
        }
        function clearboard(){
            document.getElementById(cardId).style.visibility = 'visible'
            document.getElementById(oppId).style.visibility = 'visible'
            document.getElementById('hndPlayed').style.visibility = 'hidden'
            document.getElementById('oppPlayed').style.visibility = 'hidden'
            document.getElementById('notouch').style.visibility = 'hidden'
        }
        function closeboard(){
            enableBtns()
            document.getElementById('gameWindow').style.visibility = 'hidden'
            document.getElementById('notouch').style.visibility = 'hidden'
            let cardslots = ['hnd1','hnd2','hnd3','hndPlayed','opp1','opp2','opp3','oppPlayed']
            cardslots.forEach((slot) => {
                document.getElementById(slot).style.visibility = 'hidden'
            })
        }
        function openboard(){
            document.getElementById('gameWindow').style.visibility = 'visible'
            document.getElementById('notouch').style.visibility = 'hidden'
            let cardslots = ['hnd1','hnd2','hnd3','opp1','opp2','opp3']
            cardslots.forEach((slot) => {
                document.getElementById(slot).style.visibility = 'visible'
            })
        }
        var popups = 0
        function popup(text){
            popups++
            var popuptab = document.getElementById('popup')
            popuptab.innerHTML = text
            popuptab.style.visibility = 'visible'
            setTimeout(unpop,(text.length*100)+1000)
        }
        function unpop(){
            popups--
            if(popups<=0){
                popups = 0
                document.getElementById('popup').style.visibility = 'hidden'
            }
        }
        socket.on('msg',(message) => {
            popup(message)
        })
        var cardId = 'hnd1'
        function cardSelect(dex){
            pilenum = dex
            chosencard = deck[dex][0]
            switch (dex){
                case 0:
                    cardId = 'hnd1'
                    break
                case 1:
                    cardId = 'hnd2'
                    break
                case 2:
                    cardId = 'hnd3'
                    break
            }
            document.getElementById(cardId).style.visibility = 'hidden'
            document.getElementById('hndPlayed').innerHTML = chosencard
            document.getElementById('hndPlayed').style.visibility = 'visible'
            document.getElementById('notouch').style.visibility = 'visible'
            popup('Waiting for opponent\'s move...')
        }
        function enableBtns(){
            document.getElementById('searchBtn').disabled = false
            document.getElementById('shopBtn').disabled = false
            document.getElementById('deckBtn').disabled = false
        }
        function disableBtns(){
            document.getElementById('searchBtn').disabled = true
            document.getElementById('shopBtn').disabled = true
            document.getElementById('deckBtn').disabled = true
        }

        function openShop(){
            updateGold()
            disableBtns()
            document.getElementById('shopWindow').style.visibility = 'visible'
        }
        function closeShop(){
            enableBtns()
            document.getElementById('shopWindow').style.visibility = 'hidden'
        }
        function purchase(item){
            socket.emit('purchase',item,function(pulls){
                var msg = 'You pulled:'
                pulls.forEach((card) => {
                    msg+=`<br>${card}`
                })
                popup(msg)
                bank.push(...pulls)
            })
            updateGold()
        }
        function updateGold(){
            socket.emit('balance',(balance) => {
                gold = balance
                document.getElementById('goldDisplay').innerHTML = `Gold: ${gold}`
            })
        }

        function openDeck(){
            disableBtns()
            document.getElementById('deckWindow').style.visibility = 'visible'
            renderDeck()
        }
        function closeDeck(){
            enableBtns()
            document.getElementById('deckWindow').style.visibility = 'hidden'
            document.getElementById('cardPicker').innerHTML = '<b>Click on a card to replace it.</b>'
            socket.emit('save',deck,bank)
        }
        function renderDeck(){
            for (let j = 0; j < 3; j++){
                var div = document.getElementById(`pile${j}`)
                div.innerHTML = ''
                for (let i = 0; i < deck[j].length; i++){
                    div.innerHTML+=`<button class="cardBtn" onclick="editCard(${j},${i})">${deck[j][i]}</button>`
                }
            }
        }
        function editCard(j,i){
            var div = document.getElementById('cardPicker')
            div.innerHTML = '<b>Your Cards:</b><br>'
            for (let x = 0; x < bank.length; x++){
                div.innerHTML+=`<button class="cardBtn" onclick="replaceCard(${j},${i},${x})">${bank[x]}</button>`
            }
        }
        var deckChanges = false
        function replaceCard(j,i,x){
            bank.push(deck[j].splice(i,1,bank.splice(x,1)[0])[0])
            document.getElementById('cardPicker').innerHTML = '<b>Click on a card to replace it.</b>'
            deckChanges = true
            renderDeck()
            socket.emit('deckChange',deck,bank)
        }
    </script>
    <nav>
        <button onclick="gameSearch()" id="searchBtn">Search for Game</button>
        <button onclick="openDeck()" id="deckBtn">Deck Editor</button>
        <button onclick="openShop()" id="shopBtn">Shop</button>
        <button>...</button>
    </nav>
    <div id="gameWindow">
        <progress value="0" max="25" id="opponentHealth"></progress>
        <progress value="0" max="25" id="playerHealth"></progress>
        <button id="opp1" class="card"></button>
        <button id="opp2" class="card"></button>
        <button id="opp3" class="card"></button>
        <button id="hnd1" class="card" onclick="cardSelect(0)"></button>
        <button id="hnd2" class="card" onclick="cardSelect(1)"></button>
        <button id="hnd3" class="card" onclick="cardSelect(2)"></button>
        <button id="hndPlayed" class="card"></button>
        <button id="oppPlayed" class="card"></button>
    </div>
    <div id='shopWindow'>
        <button class="close" onclick="closeShop()">X</button>
        <h1 id="shopTitle">Shop</h1>
        <h3 id="goldDisplay"></h3>
        <button class="shopBtn" onclick="purchase('commonpack')">Common Pack<br><br><br>1000 Gold</button>
    </div>
    <div id='deckWindow'>
        <button class="close" onclick="closeDeck()">X</button>
        <h1 id="deckTitle">Deck Editor</h1>
        <b class="pileLabel">Pile 1</b>
        <b class="pileLabel">Pile 2</b>
        <b class="pileLabel">Pile 3</b>
        <div id="pile0"></div>
        <div id="pile1"></div>
        <div id="pile2"></div>
        <div id="cardPicker"><b>Click on a card to replace it.</b></div>
    </div>
    <div id="notouch"></div>
    <h1 id="popup"></h1>
</body>
</html>